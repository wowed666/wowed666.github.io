---
layout: post
title: Interactive Visualizations using NOAA Climate Data
---

In this post I will be demonstrating the functions I wrote to query climate data from the NOAA and create interactive visualizations.


## 1. Create a Database

Import some necessary package:  'sqlite3' creates the database and queries data \n
								'pandas' to manipulates dataframes.
								'seaborn' for the fancy plots
								'numpy' to manipulat Data
								
```python
import pandas as pd

# advanced plotting tools for data frames
# basically a bunch of matplotlib shortcuts
import seaborn as sns 
```

from matplotlib import pyplot as plt
import numpy as np
import sqlite3

```
conn = sqlite3.connect("temps.db")
```

Lets see what does this data looked like
```python
df_iter = pd.read_csv("temps.csv", chunksize = 100000)
df = df_iter.__next__()
df.head()
```

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>VALUE1</th>
      <th>VALUE2</th>
      <th>VALUE3</th>
      <th>VALUE4</th>
      <th>VALUE5</th>
      <th>VALUE6</th>
      <th>VALUE7</th>
      <th>VALUE8</th>
      <th>VALUE9</th>
      <th>VALUE10</th>
      <th>VALUE11</th>
      <th>VALUE12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>-89.0</td>
      <td>236.0</td>
      <td>472.0</td>
      <td>773.0</td>
      <td>1128.0</td>
      <td>1599.0</td>
      <td>1570.0</td>
      <td>1481.0</td>
      <td>1413.0</td>
      <td>1174.0</td>
      <td>510.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1962</td>
      <td>113.0</td>
      <td>85.0</td>
      <td>-154.0</td>
      <td>635.0</td>
      <td>908.0</td>
      <td>1381.0</td>
      <td>1510.0</td>
      <td>1393.0</td>
      <td>1163.0</td>
      <td>994.0</td>
      <td>323.0</td>
      <td>-126.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1963</td>
      <td>-713.0</td>
      <td>-553.0</td>
      <td>-99.0</td>
      <td>541.0</td>
      <td>1224.0</td>
      <td>1627.0</td>
      <td>1620.0</td>
      <td>1596.0</td>
      <td>1332.0</td>
      <td>940.0</td>
      <td>566.0</td>
      <td>-108.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1964</td>
      <td>62.0</td>
      <td>-85.0</td>
      <td>55.0</td>
      <td>738.0</td>
      <td>1219.0</td>
      <td>1442.0</td>
      <td>1506.0</td>
      <td>1557.0</td>
      <td>1221.0</td>
      <td>788.0</td>
      <td>546.0</td>
      <td>112.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1965</td>
      <td>44.0</td>
      <td>-105.0</td>
      <td>38.0</td>
      <td>590.0</td>
      <td>987.0</td>
      <td>1500.0</td>
      <td>1487.0</td>
      <td>1477.0</td>
      <td>1377.0</td>
      <td>974.0</td>
      <td>31.0</td>
      <td>-178.0</td>
    </tr>
  </tbody>
</table>

Looks like we need to prepare the data before we put it into database.The following function prepare_df reorganizes the temperature data so that we can use it properly.

```python
def pre_df(df):
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100
    return(df)
```

Then we can use for loop to put prepared temperatures data into database

```python
for df in df_iter:
    df = pre_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False)
```

Because stations and countrys data are not large as temperatures data we can directly put it into database.
But I noticed that there is a individual country named "Taiwan". That's not correct. "Taiwan" is always a part of China. 
So before I put countrys data to database, we need to correct this mistake.

```python
url = "https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv"
countrys = pd.read_csv(url)
countrys[countrys["Name"] == "Taiwan"]
```

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FIPS 10-4</th>
      <th>ISO 3166</th>
      <th>Name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>238</th>
      <td>TW</td>
      <td>TW</td>
      <td>Taiwan</td>
    </tr>
  </tbody>
</table>

I use df.loc to change the name of "Taiwan" to "China"

```python
countrys = countrys.rename(columns = {"FIPS 10-4" : "ID"})

countrys = countrys.drop(["ISO 3166"],axis = 1)
countrys.loc[238,"Name"] = "China"
countrys.head()
countrys.to_sql("countries",conn, if_exists = "replace",index = False )

url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(url)
stations["ID"] = stations["ID"]
stations.to_sql("stations", conn, if_exists = "replace", index = False)
```
We put all three Table to the database. Well done!!! Let take a look of our three table by cursor.execute()

```python
cursor = conn.cursor()
cursor.execute("SELECT sql FROM sqlite_master WHERE type='table';")

for result in cursor.fetchall():
    print(result[0])
```
<pre>CREATE TABLE "stations" (
"ID" TEXT,
  "LATITUDE" REAL,
  "LONGITUDE" REAL,
  "STNELEV" REAL,
  "NAME" TEXT
)
CREATE TABLE "countries" (
"ID" TEXT,
  "Name" TEXT
)
CREATE TABLE "temperatures" (
"ID" TEXT,
  "Year" INTEGER,
  "Month" INTEGER,
  "Temp" REAL
)
</pre>

Looks very good! Last thing don't forget close your connect!!!

```python
conn.close()
```
